<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <!-- Android/PWA Capability Meta Tags -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Calculator">
  <meta name="apple-mobile-web-app-title" content="Calculator">
  <meta name="theme-color" content="#121212">
  <meta name="msapplication-navbutton-color" content="#121212">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>Calculator</title>

  <!-- Embedded Web Manifest for Installation -->
  <link rel="manifest" href='data:application/manifest+json,{
    "name": "Calculator App",
    "short_name": "Calc",
    "start_url": ".",
    "display": "standalone",
    "background_color": "#121212",
    "theme_color": "#121212",
    "orientation": "portrait",
    "icons": [{
      "src": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBmaWxsPSIjMzM5OWZmIj48cmVjdCB4PSI2NCIgeT0iNjQiIHdpZHRoPSIzODQiIGhlaWdodD0iMzg0IiByeD0iNjQiIHJ5PSI2NCIgZmlsbD0iIzFlMWUxZSIvPjxjaXJjbGUgY3g9IjE2MCIgY3k9IjE3MCIgcj0iMzIiIGZpbGw9IiM1NTVmNzEiLz48Y2lyY2xlIGN4PSIyNTYiIGN5PSIxNzAiIHI9IjMyIiBmaWxsPSIjNTU1ZjcxIi8+PGNpcmNsZSBjeD0iMzUyIiBjeT0iMTcwIiByPSIzMiIgZmlsbD0iIzMzOTlmZiIvPjxjaXJjbGUgY3g9IjE2MCIgY3k9IjI2MCIgcj0iMzIiIGZpbGw9IiMzMzM1M2YiLz48Y2lyY2xlIGN4PSIyNTYiIGN5PSIyNjAiIHI9IjMyIiBmaWxsPSIjMzMzNTNmIi8+PGNpcmNsZSBjeD0iMzUyIiBjeT0iMjYwIiByPSIzMiIgZmlsbD0iIzMzMzUzZiIvPjxjaXJjbGUgY3g9IjE2MCIgY3k9IjM1MCIgcj0iMzIiIGZpbGw9IiMzMzM1M2YiLz48Y2lyY2xlIGN4PSIyNTYiIGN5PSIzNTAiIHI9IjMyIiBmaWxsPSIjMzMzNTNmIi8+PGNpcmNsZSBjeD0iMzUyIiBjeT0iMzUwIiByPSIzMiIgZmlsbD0iIzAwY2ZmZiIvPjwvc3ZnPg==",
      "sizes": "512x512",
      "type": "image/svg+xml"
    }]
  }' />

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB4PSI2NCIgeT0iNjQiIHdpZHRoPSIzODQiIGhlaWdodD0iMzg0IiByeD0iNjQiIHJ5PSI2NCIgZmlsbD0iIzFlMWUxZSIvPjxjaXJjbGUgY3g9IjE2MCIgY3k9IjE3MCIgcj0iMzIiIGZpbGw9IiM1NTVmNzEiLz48Y2lyY2xlIGN4PSIyNTYiIGN5PSIxNzAiIHI9IjMyIiBmaWxsPSIjNTU1ZjcxIi8+PGNpcmNsZSBjeD0iMzUyIiBjeT0iMTcwIiByPSIzMiIgZmlsbD0iIzMzOTlmZiIvPjxjaXJjbGUgY3g9IjE2MCIgY3k9IjI2MCIgcj0iMzIiIGZpbGw9IiMzMzM1M2YiLz48Y2lyY2xlIGN4PSIyNTYiIGN5PSIyNjAiIHI9IjMyIiBmaWxsPSIjMzMzNTNmIi8+PGNpcmNsZSBjeD0iMzUyIiBjeT0iMjYwIiByPSIzMiIgZmlsbD0iIzMzMzUzZiIvPjxjaXJjbGUgY3g9IjE2MCIgY3k9IjM1MCIgcj0iMzIiIGZpbGw9IiMzMzM1M2YiLz48Y2lyY2xlIGN4PSIyNTYiIGN5PSIzNTAiIHI9IjMyIiBmaWxsPSIjMzMzNTNmIi8+PGNpcmNsZSBjeD0iMzUyIiBjeT0iMzUwIiByPSIzMiIgZmlsbD0iIzAwY2ZmZiIvPjwvc3ZnPg==">

  <style>
    :root {
      --bg: #121212;
      --calc: #1e1e1e;
      --display: #000;
      --btn: #2f2f2f;
      --txt: #fff;
      --accent: #3399ff;
      --glow-red: #00cfff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
    }

    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: var(--bg);
      font-family: 'Segoe UI', Arial, sans-serif;
      user-select: none;
      transition: background 0.3s ease;
    }

    .calculator {
      width: 100%;
      max-width: 360px;
      background: var(--calc);
      border-radius: 28px;
      padding: 20px;
      box-shadow: 0 50px 80px rgba(0, 0, 0, 0.5);
      transition: background 0.3s ease, box-shadow 0.3s ease;
      /* Mobile layout adjustments */
      display: flex;
      flex-direction: column;
    }

    @media (max-width: 400px) {
      .calculator {
        height: 100vh;
        border-radius: 0;
        justify-content: center;
        box-shadow: none;
      }
    }

    .top {
      display: flex;
      justify-content: space-between; /* Spread theme icons */
      margin-bottom: 20px;
      padding: 0 10px;
    }

    .theme {
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--btn);
      color: var(--txt);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease, background 0.3s ease;
    }
    
    .theme:active {
      transform: scale(0.9);
    }
    
    .theme svg {
      width: 20px;
      height: 20px;
      fill: var(--txt);
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .theme:hover svg {
      opacity: 1;
    }

    .display {
      background: var(--display);
      height: 96px;
      padding: 0 20px;
      border-radius: 24px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      font-size: 3rem;
      color: var(--txt);
      overflow: hidden;
      white-space: pre;
      direction: ltr;
      text-align: right;
      font-family: 'Courier New', monospace;
      text-shadow: 0 0 10px var(--glow-red); /* Fixed var name mismatch in original code */
      transition: color 0.3s ease, background 0.3s ease;
      margin-bottom: 20px;
    }

    .buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    button {
      border: none;
      border-radius: 50%;
      aspect-ratio: 1; /* Keep perfect circles */
      font-size: 1.5rem;
      cursor: pointer;
      background: var(--btn);
      color: var(--txt);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: inherit;
      position: relative;
      transition: transform 0.1s ease, background 0.3s ease, color 0.3s ease;
    }

    button:active {
      transform: scale(0.92);
    }

    button svg {
      width: 28px;
      height: 28px;
      fill: currentColor;
    }

    button.glowing {
      box-shadow: 0 0 22px var(--glow-red), inset 0 0 12px rgba(255,255,255,0.2);
      background: var(--accent); /* Changed logic for visual feedback */
      color: #000;
    }

    .op {
      color: var(--accent);
      font-weight: bold;
    }

    .equal {
      background: var(--accent);
      color: #000; /* Contrast text for accent */
      border-radius: 36px;
    }
    
    .equal svg {
        fill: #000;
    }

    .zero {
      grid-column: span 2;
      border-radius: 36px;
      aspect-ratio: auto; /* Override aspect-ratio for wide zero */
    }

    @keyframes popIn {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .pop {
      animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div class="calculator">
    <div class="top">
      <!-- Dark Theme -->
      <button class="theme" onclick="theme(1)" aria-label="Dark Theme">
        <svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
      </button>
      <!-- Blue Theme -->
      <button class="theme" onclick="theme(2)" aria-label="Blue Theme">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><circle cx="12" cy="12" r="5"/></svg>
      </button>
      <!-- Purple Theme -->
      <button class="theme" onclick="theme(3)" aria-label="Purple Theme">
        <svg viewBox="0 0 24 24"><path d="M13 2L3 14h7v8l10-12h-7z"/></svg>
      </button>
      <!-- Light Theme -->
      <button class="theme" onclick="theme(4)" aria-label="Light Theme">
         <svg viewBox="0 0 24 24"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zm-3.21 13.7l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-1 16.95h2V19.5h-2v2.95zm-7.45-3.91l1.41 1.41 1.79-1.8-1.41-1.41-1.79 1.8z"/></svg>
      </button>
    </div>

    <div class="display" id="display">0</div>

    <div class="buttons">
      <!-- ROW 1 -->
      <button data-action="op" onclick="inputOp('/')" class="op" aria-label="Divide">
        <svg viewBox="0 0 24 24"><path d="M19 13H5v-2h14v2zM12 5c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm0 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
      </button>
      
      <button data-action="percent" onclick="percent()" class="op" aria-label="Percentage">
        <svg viewBox="0 0 24 24"><path d="M18.5 3.5l-15 15 2 2 15-15-2-2zM7 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm10 10c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3z"/></svg>
      </button>
      
      <button data-action="back" onclick="back()" class="op" aria-label="Backspace">
        <svg viewBox="0 0 24 24"><path d="M22 3H7c-.69 0-1.23.35-1.59.88L0 12l5.41 8.11c.36.53.9.89 1.59.89h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-3 12.59L17.59 17 14 13.41 10.41 17 9 15.59 12.59 12 9 8.41 10.41 7 14 10.59 17.59 7 19 8.41 15.41 12 19 15.59z"/></svg>
      </button>
      
      <button data-action="clear" onclick="clearAll()" class="op">C</button>

      <!-- ROW 2 -->
      <button data-action="op" onclick="inputOp('*')" class="op" aria-label="Multiply">
        <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
      </button>
      <button data-action="num" onclick="inputNum('9')">9</button>
      <button data-action="num" onclick="inputNum('8')">8</button>
      <button data-action="num" onclick="inputNum('7')">7</button>

      <!-- ROW 3 -->
      <button data-action="op" onclick="inputOp('-')" class="op" aria-label="Subtract">
        <svg viewBox="0 0 24 24"><path d="M19 13H5v-2h14v2z"/></svg>
      </button>
      <button data-action="num" onclick="inputNum('6')">6</button>
      <button data-action="num" onclick="inputNum('5')">5</button>
      <button data-action="num" onclick="inputNum('4')">4</button>

      <!-- ROW 4 -->
      <button data-action="op" onclick="inputOp('+')" class="op" aria-label="Add">
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
      </button>
      <button data-action="num" onclick="inputNum('3')">3</button>
      <button data-action="num" onclick="inputNum('2')">2</button>
      <button data-action="num" onclick="inputNum('1')">1</button>

      <!-- ROW 5 -->
      <button data-action="equal" onclick="calculate()" class="equal" aria-label="Equals">
        <svg viewBox="0 0 24 24"><path d="M19 15H5v-2h14v2zm0-4H5V9h14v2z"/></svg>
      </button>
      <button data-action="dot" onclick="inputDot()">.</button>
      <button data-action="num" onclick="inputNum('0')" class="zero">0</button>
    </div>
  </div>

  <script>
    const display = document.getElementById("display");
    let currentInput = "0";
    let previousInput = "";
    let operation = null;
    let resetScreen = false;
    let activeButton = null;
    let displayedChars = [];

    function getDisplayText() {
      if (operation === null) {
        return currentInput;
      } else {
        if (resetScreen && currentInput === "0") {
          let opSymbol = operation === '*' ? '×' : operation === '/' ? '÷' : operation;
          return `${previousInput} ${opSymbol}`;
        } else {
          let opSymbol = operation === '*' ? '×' : operation === '/' ? '÷' : operation;
          return `${previousInput} ${opSymbol} ${currentInput}`;
        }
      }
    }

    function updateDisplay() {
      const text = getDisplayText();
      // Handle Font Scaling
      const baseSize = 3.0; // matched css
      const maxChars = 10;
      let fontSize = baseSize;
      
      // Rough character width estimation
      if (text.length > 8) {
          fontSize = Math.max(1.5, baseSize * (8 / text.length));
      }
      
      display.style.fontSize = fontSize + 'rem';

      // Animation Logic
      const currentChars = text.split('');
      if (text.length <= displayedChars.length && text === displayedChars.join('')) {
        return;
      }

      display.innerHTML = '';
      displayedChars = currentChars;

      currentChars.forEach((char, i) => {
        const span = document.createElement('span');
        span.textContent = char;
        // Only animate the last few characters to avoid flashing the whole number constantly
        if (i >= currentChars.length - 2) {
             span.classList.add('pop');
             span.style.animationDelay = `${(i - (currentChars.length - 2)) * 0.05}s`;
        }
        display.appendChild(span);
      });
    }

    function activateButton(btn) {
      if (activeButton) {
        activeButton.classList.remove('glowing');
      }
      if (btn && !['clear', 'equal'].includes(btn.dataset.action)) {
        btn.classList.add('glowing');
        activeButton = btn;
      } else {
        activeButton = null;
      }
    }

    function inputNum(number) {
      // Find button if function called via keyboard
      const btn = event.currentTarget || document.querySelector(`button[onclick*="inputNum('${number}')"]`);
      if(btn && btn.tagName === 'BUTTON') activateButton(btn);

      if (resetScreen) {
        currentInput = number;
        resetScreen = false;
      } else {
        if (currentInput === "0") {
          currentInput = number;
        } else {
          if (currentInput.length >= 14) return;
          currentInput += number;
        }
      }
      updateDisplay();
    }

    function inputDot() {
      const btn = event.currentTarget || document.querySelector(`button[onclick*="inputDot"]`);
      if(btn && btn.tagName === 'BUTTON') activateButton(btn);

      if (resetScreen) {
        currentInput = "0.";
        resetScreen = false;
      } else if (!currentInput.includes(".")) {
        currentInput += ".";
      }
      updateDisplay();
    }

    function clearAll() {
      activateButton(null);
      currentInput = "0";
      previousInput = "";
      operation = null;
      resetScreen = false;
      displayedChars = [];
      updateDisplay();
    }

    function back() {
      const btn = event.currentTarget || document.querySelector(`button[onclick*="back"]`);
      if(btn && btn.tagName === 'BUTTON') activateButton(btn);

      if (operation !== null && resetScreen && currentInput === "0") {
        operation = null;
        currentInput = previousInput;
        previousInput = "";
        resetScreen = false;
      } else if (currentInput.length === 1 || (currentInput.length === 2 && currentInput.startsWith("-"))) {
        currentInput = "0";
      } else {
        currentInput = currentInput.slice(0, -1);
      }
      updateDisplay();
    }

    function percent() {
      const btn = event.currentTarget || document.querySelector(`button[onclick*="percent"]`);
      if(btn && btn.tagName === 'BUTTON') activateButton(btn);

      const value = parseFloat(currentInput);
      currentInput = (value / 100).toString();
      resetScreen = false;
      updateDisplay();
    }

    function inputOp(op) {
      const btn = event.currentTarget || document.querySelector(`button[onclick*="inputOp('${op}')"]`);
      if(btn && btn.tagName === 'BUTTON') activateButton(btn);

      if (operation !== null) {
        if (!resetScreen) {
          calculate();
          previousInput = currentInput;
          operation = op;
          currentInput = "0";
          resetScreen = true;
        } else {
          operation = op;
          updateDisplay();
          return;
        }
      } else {
        previousInput = currentInput;
        operation = op;
        currentInput = "0";
        resetScreen = true;
      }
      updateDisplay();
    }

    function calculate() {
      activateButton(null);
      if (operation === null || previousInput === "" || resetScreen) return;

      let computation;
      const prev = parseFloat(previousInput);
      const current = parseFloat(currentInput);
      if (isNaN(prev) || isNaN(current)) return;

      switch (operation) {
        case "+": computation = prev + current; break;
        case "-": computation = prev - current; break;
        case "*": computation = prev * current; break;
        case "/":
          if (current === 0) {
            currentInput = "Error";
            displayedChars = [];
            updateDisplay();
            setTimeout(clearAll, 1500);
            return;
          }
          computation = prev / current;
          break;
        default: return;
      }

      currentInput = computation.toString();
      if (currentInput.length > 14) {
        // Avoid extremely long decimals
        currentInput = parseFloat(computation.toPrecision(10)).toString();
      }

      operation = null;
      previousInput = "";
      resetScreen = true;
      displayedChars = [];
      updateDisplay();
    }

    document.addEventListener("keydown", (e) => {
      // Prevent default browser actions for some keys to avoid scrolling/etc
      if (e.key === '/') e.preventDefault();
      
      if (/[0-9]/.test(e.key)) {
        inputNum(e.key);
      } else if (e.key === ".") inputDot();
      else if (e.key === "Enter" || e.key === "=") calculate();
      else if (e.key === "Escape") clearAll();
      else if (e.key === "Backspace") back();
      else if (e.key === "+") inputOp('+');
      else if (e.key === "-") inputOp('-');
      else if (e.key === "*") inputOp('*');
      else if (e.key === "/") inputOp('/');
    });

    function theme(t) {
      if (t === 1) set("#121212", "#1e1e1e", "#000", "#2f2f2f", "#fff", "#3399ff", "#00cfff");
      if (t === 2) set("#001f2f", "#00334d", "#00151f", "#004d73", "#e0f7ff", "#00e5ff", "#00ffff");
      if (t === 3) set("#1a0026", "#2b003d", "#14001f", "#4a0066", "#f2e6ff", "#c77dff", "#ff00ff");
      if (t === 4) set("#f2f2f2", "#fff", "#eee", "#e0e0e0", "#000", "#ff9800", "#0077ff");
      
      // Update theme-color meta tag for Android status bar
      const metaThemeColor = document.querySelector("meta[name=theme-color]");
      if(t === 1) metaThemeColor.setAttribute("content", "#121212");
      if(t === 2) metaThemeColor.setAttribute("content", "#001f2f");
      if(t === 3) metaThemeColor.setAttribute("content", "#1a0026");
      if(t === 4) metaThemeColor.setAttribute("content", "#f2f2f2");
    }

    function set(bg, calc, displayBg, btn, txt, accent, glow) {
      document.documentElement.style.setProperty("--bg", bg);
      document.documentElement.style.setProperty("--calc", calc);
      document.documentElement.style.setProperty("--display", displayBg);
      document.documentElement.style.setProperty("--btn", btn);
      document.documentElement.style.setProperty("--txt", txt);
      document.documentElement.style.setProperty("--accent", accent);
      document.documentElement.style.setProperty("--glow-red", glow);
    }
    
    // Initial call to set color
    theme(1);
    updateDisplay();
  </script>
</body>
</html>